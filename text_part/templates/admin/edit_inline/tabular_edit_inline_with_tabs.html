{% load i18n admin_static admin_modify %}
<div class="inline-group {{ inline_admin_formset.opts.suit_classes }}"
     id="{{ inline_admin_formset.formset.prefix }}-group">
    <div class="tabular inline-related {% if forloop.last %}last-related{% endif %}">
        {{ inline_admin_formset.formset.management_form }}
        <fieldset class="module">
            <h2>{{ inline_admin_formset.opts.verbose_name_plural|capfirst }}</h2>
            {{ inline_admin_formset.formset.non_form_errors }}
            <table class="table table-bordered table-condensed table-striped">
                <thead>
                    <tr>
                        <th>&nbsp;</th>
                        {% if inline_admin_formset.formset.can_delete %}
                            <th>{% trans "Delete?" %}</th>
                        {% endif %}
                    </tr>
                </thead>

                <tbody>
                {% for inline_admin_form in inline_admin_formset %}
                    {% with suit_tab_prefix=forloop.counter %}
                        <tr>
                            <td>
                                <ul id="suit_inline_form_tabs_{{ forloop.counter }}" class="nav nav-tabs nav-tabs-suit" data-tab-prefix="suit_inline_form_tabs_{{ suit_tab_prefix }}">
                                    {% for fieldset_label, fieldset_data in inline_admin_formset.fieldsets %}
                                        <li><a href="#{{ fieldset_label }}">{{ fieldset_label }}</a></li>
                                    {% endfor %}
                                </ul>

                                {% for fieldset_label, fieldset_data in inline_admin_formset.fieldsets %}

                                    <div class="tab-content suit_inline_form_tabs_{{ suit_tab_prefix }} suit_inline_form_tabs_{{ suit_tab_prefix }}-{{ fieldset_label }}">
                                        {% for fieldset in inline_admin_form %}
                                            {% for line in fieldset %}
                                                {% for field in line %}

                                                    {% if field.field.name in fieldset_data.fields %}
                                                        {{ field.field }}
                                                    {% endif %}

                                                {% endfor %}
                                            {% endfor %}
                                        {% endfor %}
                                    </div>

                                {% endfor %}

                            </td>
                            {% if inline_admin_formset.formset.can_delete %}
                                <td class="delete">{% if inline_admin_form.original %}{{ inline_admin_form.deletion_field.field }}{% endif %}</td>
                            {% endif %}
                        </tr>
                    {% endwith %}
                {% endfor %}
                </tbody>
            </table>
        </fieldset>
    </div>
</div>

<script type="text/javascript">
    (function ($) {
        $(document).ready(function ($) {

            {% for inline_admin_form in inline_admin_formset %}
                (function ($) {
                    $(function () {
                        $('#suit_inline_form_tabs_{{ forloop.counter }}').suit_form_tabs();
                    });
                }(Suit.$))
            {% endfor %}

            var rows = "#{{ inline_admin_formset.formset.prefix }}-group .tabular.inline-related tbody tr";
            var alternatingRows = function (row) {
                $(rows).not(".add-row").removeClass("row1 row2")
                        .filter(":even").addClass("row1").end()
                        .filter(rows + ":odd").addClass("row2");
            }
            var reinitDateTimeShortCuts = function () {
                // Reinitialize the calendar and clock widgets by force
                if (typeof DateTimeShortcuts != "undefined") {
                    $(".datetimeshortcuts").remove();
                    DateTimeShortcuts.init();
                }
            }
            var updateSelectFilter = function () {
                // If any SelectFilter widgets are a part of the new form,
                // instantiate a new SelectFilter instance for it.
                if (typeof SelectFilter != "undefined") {
                    $(".selectfilter").each(function (index, value) {
                        var namearr = value.name.split('-');
                        SelectFilter.init(value.id, namearr[namearr.length - 1], false, "{% static "admin/" %}");
                    });
                    $(".selectfilterstacked").each(function (index, value) {
                        var namearr = value.name.split('-');
                        SelectFilter.init(value.id, namearr[namearr.length - 1], true, "{% static "admin/" %}");
                    });
                }
            }
            var initPrepopulatedFields = function (row) {
                row.find('.prepopulated_field').each(function () {
                    var field = $(this);
                    var input = field.find('input, select, textarea');
                    var dependency_list = input.data('dependency_list') || [];
                    var dependencies = [];
                    $.each(dependency_list, function (i, field_name) {
                        dependencies.push('#' + row.find('.field-' + field_name).find('input, select, textarea').attr('id'));
                    });
                    if (dependencies.length) {
                        input.prepopulate(dependencies, input.attr('maxlength'));
                    }
                });
            }
            $(rows).formset({
                prefix: "{{ inline_admin_formset.formset.prefix }}",
                addText: "{% blocktrans with verbose_name=inline_admin_formset.opts.verbose_name|title %}Add another {{ verbose_name }}{% endblocktrans %}",
                formCssClass: "dynamic-{{ inline_admin_formset.formset.prefix }}",
                deleteCssClass: "inline-deletelink",
                deleteText: "{% trans "Remove" %}",
                emptyCssClass: "empty-form",
                removed: alternatingRows,
                added: (function (row) {
                    initPrepopulatedFields(row);
                    reinitDateTimeShortCuts();
                    updateSelectFilter();
                    alternatingRows(row);
                    Suit.after_inline.run("{{ inline_admin_formset.formset.prefix }}", row);
                })
            });
        });
    })(django.jQuery);
</script>
